generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Event {
  id                String               @id @default(cuid())
  title             String
  eventType         String
  location          String
  latitude          Float?
  longitude         Float?
  startDate         DateTime
  endDate           DateTime?
  cost              Float?
  description       String?
  isRecurring       Boolean              @default(false)
  imageUrl          String?
  minTeams          Int?
  maxTeams          Int?
  acceptedTeamTypes String[]             @default([])
  visibility        TournamentVisibility @default(PUBLIC)
  status            EventStatus          @default(UPCOMING)
  bracketType       BracketType?
  bracketData       Json?
  divisions         String[]             @default([])
  maxTeamsPerClub   Int?                 @default(1)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  clubId            String?
  pitchLocationId   String?             // Deprecated: use pitchLocations instead
  club              Club?                @relation(fields: [clubId], references: [id])
  pitchLocation     PitchLocation?       @relation("MainPitch", fields: [pitchLocationId], references: [id])
  pitchLocations    EventPitchLocation[] // New: multiple pitches support
  interests         Interest[]
  matches           Match[]
  surveyResponses   SurveyResponse[]
  teams             TournamentTeam[]
  report            EventReport?

  @@index([startDate])
  @@index([eventType])
  @@index([location])
  @@index([clubId])
  @@index([startDate, eventType])
  @@index([latitude, longitude])
  @@index([acceptedTeamTypes])
  @@index([visibility])
  @@index([pitchLocationId])
  @@index([status])
}

model Interest {
  id          String   @id @default(cuid())
  eventId     String
  name        String
  email       String
  message     String?
  submittedAt DateTime @default(now())
  event       Event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([submittedAt])
}

model Club {
  id                  String               @id @default(cuid())
  name                String
  region              String?
  subRegion           String?
  map                 String?
  facebook            String?
  instagram           String?
  website             String?
  codes               String?
  imageUrl            String?
  location            String?
  latitude            Float?
  longitude           Float?
  teamTypes           String[]             @default([])
  contactFirstName    String?
  contactLastName     String?
  contactEmail        String?
  contactPhone        String?
  contactCountryCode  String?
  isContactWilling    Boolean              @default(false)
  status              ClubStatus           @default(PENDING)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now()) @updatedAt
  submittedBy         String?
  reviewedAt          DateTime?
  reviewedBy          String?
  rejectionReason     String?
  adminNotes          String?
  verificationStatus  ClubVerificationStatus @default(UNVERIFIED)
  verifiedAt          DateTime?
  verifiedBy          String?
  verificationDetails Json?
  lastVerificationCheck DateTime?
  verificationExpiry  DateTime?
  availabilitySlots   AvailabilitySlot[]
  bookings            Booking[]
  clubAdminRequests   ClubAdminRequest[]
  clubInterests       ClubInterest[]
  events              Event[]
  hostingPackages     HostingPackage[]
  pitchLocations      PitchLocation[]
  tournamentInterests TournamentInterest[]
  tournamentTeams     TournamentTeam[]
  testimonials        Testimonial[]
  members             User[]               @relation("ClubMembers")
  admins              User[]               @relation("ClubAdmins")
  verifier            User?                @relation("ClubVerifier", fields: [verifiedBy], references: [id])

  @@index([status])
  @@index([location])
  @@index([teamTypes])
  @@index([name])
  @@index([latitude, longitude])
  @@index([region, subRegion])
  @@index([createdAt])
  @@index([submittedBy])
  @@index([verificationStatus])
  @@index([verifiedAt])
}

model User {
  id                    String               @id @default(cuid())
  email                 String               @unique
  username              String               @unique
  password              String
  name                  String?
  role                  UserRole             @default(USER)
  accountStatus         AccountStatus        @default(PENDING)
  clubId                String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  approvedAt            DateTime?
  approvedBy            String?
  rejectionReason       String?
  accounts              Account[]
  reviewedAdminRequests ClubAdminRequest[]   @relation("AdminRequestReviewer")
  clubAdminRequests     ClubAdminRequest[]
  passwordResetTokens   PasswordResetToken[]
  pitchLocations        PitchLocation[]
  pitchRequests         PitchRequest[]
  sessions              Session[]
  tournamentInterests   TournamentInterest[]
  eventReports          EventReport[]
  testimonials          Testimonial[]
  testimonialSuperAdminApprovals Testimonial[] @relation("TestimonialSuperAdminApprover")
  testimonialClubAdminApprovals  Testimonial[] @relation("TestimonialClubAdminApprover")
  club                  Club?                @relation("ClubMembers", fields: [clubId], references: [id])
  preferences           UserPreferences?
  adminOfClubs          Club[]               @relation("ClubAdmins")
  verifiedClubs         Club[]               @relation("ClubVerifier")

  @@index([accountStatus])
  @@index([role])
  @@index([clubId])
  @@index([createdAt])
  @@index([email])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SurveyResponse {
  id                    String   @id @default(cuid())
  eventId               String?
  role                  String
  clubName              String?
  country               String
  city                  String?
  hasTraveledAbroad     String
  travelFrequency       String?
  destinationsVisited   String[] @default([])
  preferredTravelTime   String
  teamSize              String
  budgetPerPerson       String
  biggestChallenge      String
  interestedServices    String[] @default([])
  wouldHost             String
  wouldPayForPlatform   String
  improvementSuggestion String?
  additionalFeedback    String?
  contactName           String
  contactEmail          String
  contactPhone          String?
  submittedAt           DateTime @default(now())
  ipAddress             String?
  userAgent             String?
  referrer              String?
  event                 Event?   @relation(fields: [eventId], references: [id])
}

model ClubInterest {
  id          String   @id @default(cuid())
  clubId      String
  name        String
  email       String
  message     String?
  type        String
  submittedAt DateTime @default(now())
  club        Club     @relation(fields: [clubId], references: [id])
}

model ClubAdminRequest {
  id              String                 @id @default(cuid())
  userId          String
  clubId          String
  reason          String
  status          ClubAdminRequestStatus @default(PENDING)
  requestedAt     DateTime               @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  club            Club                   @relation(fields: [clubId], references: [id])
  reviewer        User?                  @relation("AdminRequestReviewer", fields: [reviewedBy], references: [id])
  user            User                   @relation(fields: [userId], references: [id])

  @@unique([userId, clubId])
  @@index([status])
  @@index([clubId])
  @@index([requestedAt])
}

model HostingPackage {
  id              String    @id @default(cuid())
  clubId          String
  name            String
  description     String?
  basePrice       Float
  dayPassPrice    Float?
  maxTeams        Int       @default(1)
  maxParticipants Int?
  services        String[]  @default([])
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  bookings        Booking[]
  club            Club      @relation(fields: [clubId], references: [id])
}

model Booking {
  id            String          @id @default(cuid())
  clubId        String
  packageId     String?
  contactName   String
  contactEmail  String
  contactPhone  String?
  teamName      String
  teamSize      Int
  arrivalDate   DateTime
  departureDate DateTime
  totalAmount   Float
  platformFee   Float
  clubEarnings  Float
  status        BookingStatus   @default(INQUIRY)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  club          Club            @relation(fields: [clubId], references: [id])
  package       HostingPackage? @relation(fields: [packageId], references: [id])
  payments      Payment[]
}

model Payment {
  id              String        @id @default(cuid())
  bookingId       String
  amount          Float
  type            PaymentType
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  booking         Booking       @relation(fields: [bookingId], references: [id])
}

model TournamentTeam {
  id           String     @id @default(cuid())
  eventId      String
  clubId       String
  teamName     String
  teamType     String
  division     String?
  registeredAt DateTime   @default(now())
  status       TeamStatus @default(REGISTERED)
  awayMatches  Match[]    @relation("AwayTeam")
  homeMatches  Match[]    @relation("HomeTeam")
  winnerReports    EventReport[] @relation("WinnerTeam")
  runnerUpReports  EventReport[] @relation("RunnerUpTeam")
  thirdPlaceReports EventReport[] @relation("ThirdPlaceTeam")
  club         Club       @relation(fields: [clubId], references: [id])
  event        Event      @relation(fields: [eventId], references: [id])

  @@unique([eventId, clubId, teamName, division])
  @@index([division])
}

model Match {
  id         String         @id @default(cuid())
  eventId    String
  homeTeamId String?
  awayTeamId String?
  division   String?
  matchDate  DateTime?
  venue      String?
  round      String?
  bracketPosition Int?
  nextMatchId String?
  homeScore  Int?
  awayScore  Int?
  status     MatchStatus    @default(SCHEDULED)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  awayTeam   TournamentTeam? @relation("AwayTeam", fields: [awayTeamId], references: [id])
  event      Event          @relation(fields: [eventId], references: [id])
  homeTeam   TournamentTeam? @relation("HomeTeam", fields: [homeTeamId], references: [id])
  nextMatch  Match?         @relation("NextMatch", fields: [nextMatchId], references: [id])
  previousMatches Match[]    @relation("NextMatch")
  
  @@index([bracketPosition])
  @@index([nextMatchId])
  @@index([division])
}

model AvailabilitySlot {
  id          String   @id @default(cuid())
  clubId      String
  date        DateTime
  isRecurring Boolean  @default(false)
  dayOfWeek   Int?
  timeSlots   String[]
  capacity    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  club        Club     @relation(fields: [clubId], references: [id])

  @@index([clubId, date])
  @@index([date])
}

model TournamentInterest {
  id             String           @id @default(cuid())
  userId         String
  clubId         String
  interestType   InterestType
  specificDate   DateTime?
  monthYear      DateTime?
  dateRangeStart DateTime?
  dateRangeEnd   DateTime?
  teamSize       Int
  flexibility    FlexibilityLevel @default(FLEXIBLE)
  message        String?
  status         InterestStatus   @default(PENDING)
  suggestedDates DateTime[]
  clubResponse   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  club           Club             @relation(fields: [clubId], references: [id])
  user           User             @relation(fields: [userId], references: [id])

  @@index([clubId, status])
  @@index([userId])
  @@index([monthYear])
  @@index([status])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model UserPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  motivations         String[]
  competitiveLevel    String?
  preferredCities     String[]
  preferredCountries  String[]
  preferredClubs      String[]
  activities          String[]
  budgetRange         String?
  maxFlightTime       Int?
  preferredMonths     String[]
  onboardingCompleted Boolean  @default(false)
  onboardingSkipped   Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum UserRole {
  SUPER_ADMIN
  CLUB_ADMIN
  GUEST_ADMIN
  USER
}

enum AccountStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ClubStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TournamentVisibility {
  PUBLIC
  PRIVATE
}

enum ClubAdminRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  INQUIRY
  QUOTE_SENT
  CONFIRMED
  DEPOSIT_PAID
  FULL_PAID
  COMPLETED
  CANCELLED
}

enum PaymentType {
  DEPOSIT
  FULL_PAYMENT
  REFUND
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum TeamStatus {
  REGISTERED
  CONFIRMED
  WITHDRAWN
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum InterestType {
  SPECIFIC_DATE
  ENTIRE_MONTH
  DATE_RANGE
  MULTIPLE_MONTHS
}

enum FlexibilityLevel {
  FIXED
  FLEXIBLE
  VERY_FLEXIBLE
}

enum InterestStatus {
  PENDING
  IN_DISCUSSION
  APPROVED
  REJECTED
  CANCELLED
}

enum ClubVerificationStatus {
  UNVERIFIED
  PENDING_VERIFICATION
  VERIFIED
  EXPIRED
  DISPUTED
}

enum PitchRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportStatus {
  DRAFT
  PUBLISHED
}

enum EventStatus {
  UPCOMING
  ACTIVE
  CLOSED
}

enum BracketType {
  SINGLE_ELIMINATION
  DOUBLE_ELIMINATION
  ROUND_ROBIN
  GROUP_STAGE
}

model CityDefaultImage {
  id        String   @id @default(cuid())
  city      String   @unique
  imageUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([city])
}

model PitchLocation {
  id        String   @id @default(cuid())
  name      String
  address   String?
  city      String
  latitude  Float
  longitude Float
  clubId    String
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Basic pitch information
  originalPurpose String?  // Original sport the pitch was built for
  surfaceType     String?  // Grass, artificial turf, sand-based, hybrid, etc.
  numberOfPitches Int?     // How many pitches at this location
  
  // Amenities
  hasFloodlights    Boolean @default(false)
  floodlightHours   String? // Operating hours if available
  changingRooms     String? // Description of changing facilities
  spectatorFacilities String? // Stand capacity, terracing info
  parking           String? // Parking availability details
  otherAmenities    String? // Clubhouse, catering, equipment storage
  
  // Availability & Booking
  seasonalAvailability String? // Winter restrictions, close seasons
  bookingSystem       String?  // How to book, contact process
  bookingLeadTime     String?  // Advance booking requirements
  
  // Capacity & Restrictions
  maxPlayerCapacity   Int?    // Maximum players
  maxSpectatorCapacity Int?   // Maximum spectators
  ageGroupSuitability String? // Youth, Adult, Mixed
  tournamentCapacity  Int?    // Teams for tournaments
  equipmentProvided   String? // Goals, line marking, etc.
  
  // Contact & Navigation
  contactName        String? // Pitch contact person
  contactPhone       String? // Contact phone number
  contactEmail       String? // Contact email
  customDirections   String? // Special navigation instructions
  
  // History
  previousEvents     String? // Description of past events held here
  
  club      Club     @relation(fields: [clubId], references: [id])
  creator   User     @relation(fields: [createdBy], references: [id])
  events    Event[]  @relation("MainPitch")
  eventPitchLocations EventPitchLocation[]
  
  @@index([city])
  @@index([clubId])
  @@index([latitude, longitude])
}

model PitchRequest {
  id          String              @id @default(cuid())
  userId      String
  clubId      String
  pitchName   String
  address     String?
  city        String
  message     String?
  status      PitchRequestStatus  @default(PENDING)
  createdAt   DateTime            @default(now())
  processedAt DateTime?
  processedBy String?
  
  user        User                @relation(fields: [userId], references: [id])
  
  @@index([clubId])
  @@index([status])
  @@index([userId])
}

model EventReport {
  id              String         @id @default(cuid())
  eventId         String         @unique
  createdBy       String
  status          ReportStatus   @default(DRAFT)
  
  // Tournament Results (optional)
  winnerTeamId    String?
  runnerUpTeamId  String?
  thirdPlaceTeamId String?
  
  // Participating Teams
  participatingTeams Json?       // Array of {teamId, teamName, clubName, finalPosition}
  
  // Match Results Summary
  matchResults    Json?          // Array of key match results with scores
  
  // Bracket Data Snapshot
  finalBracket    Json?          // Final bracket state for visualization
  
  // Player Awards (optional)
  playerAwards    Json?          // Array of {awardType, playerName, teamName}
  
  // Event Details
  amenitiesProvided String?      // Free text describing what was included (meals, drinks, etc.)
  eventHighlights   String?      // Key moments or highlights from the event
  summary          String?       // Overall event summary
  
  // Media (to be implemented later)
  mediaUrls       String[]       @default([])
  
  // Metadata
  publishedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  event           Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  creator         User           @relation(fields: [createdBy], references: [id])
  winnerTeam      TournamentTeam? @relation("WinnerTeam", fields: [winnerTeamId], references: [id])
  runnerUpTeam    TournamentTeam? @relation("RunnerUpTeam", fields: [runnerUpTeamId], references: [id])
  thirdPlaceTeam  TournamentTeam? @relation("ThirdPlaceTeam", fields: [thirdPlaceTeamId], references: [id])
  
  @@index([eventId])
  @@index([status])
  @@index([createdBy])
}

// Join table for many-to-many relationship between Events and PitchLocations
model EventPitchLocation {
  id              String        @id @default(cuid())
  eventId         String
  pitchLocationId String
  isPrimary       Boolean       @default(false) // Mark primary venue
  notes           String?       // Specific notes for this venue in this event
  createdAt       DateTime      @default(now())
  
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  pitchLocation   PitchLocation @relation(fields: [pitchLocationId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, pitchLocationId])
  @@index([eventId])
  @@index([pitchLocationId])
}

model Testimonial {
  id                    String              @id @default(cuid())
  clubId                String
  userId                String
  content               String              @db.VarChar(500)
  status                TestimonialStatus   @default(PENDING)
  displayOrder          Int                 @default(0)
  deleteRequested       Boolean             @default(false)
  deleteRequestedAt     DateTime?
  submittedAt           DateTime            @default(now())
  superAdminApprovedAt  DateTime?
  superAdminApprovedBy  String?
  clubAdminApprovedAt   DateTime?
  clubAdminApprovedBy   String?
  updatedAt             DateTime            @updatedAt
  
  club                  Club                @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user                  User                @relation(fields: [userId], references: [id])
  superAdminApprover    User?               @relation("TestimonialSuperAdminApprover", fields: [superAdminApprovedBy], references: [id])
  clubAdminApprover     User?               @relation("TestimonialClubAdminApprover", fields: [clubAdminApprovedBy], references: [id])
  
  @@unique([clubId, userId])
  @@index([clubId, status])
  @@index([userId])
  @@index([status])
  @@index([displayOrder])
}

enum TestimonialStatus {
  PENDING
  SUPER_ADMIN_APPROVED
  APPROVED
  REJECTED
}
